<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jurnal RelaÈ›ional</title>
  <style>
    :root{
      /* Warm palette */
      --bg0:#130A06;
      --bg1:#20110A;

      --paper:#F6E8D6;
      --paper2:#F2DDC4;
      --ink:#2A160D;
      --muted:#6A3E2B;

      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);

      --terracotta:#C75C3A;
      --amber:#E2A23A;
      --rose:#D47B6A;
      --olive:#7D8C4A;

      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.92);
      background:
        radial-gradient(900px 600px at 18% 20%, rgba(199,92,58,.18), transparent 60%),
        radial-gradient(800px 520px at 85% 28%, rgba(226,162,58,.14), transparent 60%),
        radial-gradient(900px 600px at 35% 92%, rgba(212,123,106,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px;}
    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px;}
    .subtitle{margin:6px 0 0;color:rgba(255,255,255,.70);font-size:13px;max-width:760px}

    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .pill{
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.75);
      font-size:12px;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:1020px){
      .grid{grid-template-columns: 1.15fr .85fr;}
    }

    .card{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      padding:16px;
      overflow:hidden;
      position:relative;
    }

    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .two{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:680px){.two{grid-template-columns:1fr 1fr;}}

    label{display:block;margin:10px 0 6px;color:rgba(255,255,255,.70);font-size:12px;}
    input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      outline:none;
    }
    textarea{min-height:92px;resize:vertical;}

    .q{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      transition: transform .12s ease, border-color .12s ease;
    }
    .q:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20);}
    .qtop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .qtitle{font-size:14px;line-height:1.3;margin:0;}
    .qmeta{display:flex;gap:8px;align-items:center;}
    .badge{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      font-size:12px;color:rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .emoji{font-size:18px}

    .slider{width:100%;margin-top:10px; accent-color: var(--amber);}
    .scale{display:flex;justify-content:space-between;margin-top:6px;color:rgba(255,255,255,.65);font-size:11px;}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:10px 14px;
      font-weight:800;
      color:#1c0f09;
      background: linear-gradient(90deg, var(--amber), var(--terracotta));
      transition: transform .08s ease, opacity .12s ease;
    }
    button:active{transform: translateY(1px);}
    .ghost{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.14);
      font-weight:700;
    }
    .msg{margin:10px 0 0;color:rgba(255,255,255,.72);font-size:12px;}

    /* Journal pages */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.78);
      font-size:12px;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(90deg, rgba(226,162,58,.22), rgba(199,92,58,.18));
      border-color: rgba(255,255,255,.22);
      color: rgba(255,255,255,.92);
      font-weight:800;
    }

    .paper{
      background: radial-gradient(900px 500px at 30% 15%, var(--paper), var(--paper2));
      color: var(--ink);
      border-radius: 18px;
      border: 1px solid rgba(60,30,20,.18);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      padding: 16px 16px 14px 16px;
      position: relative;
      overflow:hidden;
    }
    .paper:before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(90,55,38,.08),
          rgba(90,55,38,.08) 1px,
          transparent 1px,
          transparent 26px
        );
      opacity:.55;
      pointer-events:none;
    }
    .paper:after{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:12px;
      background: linear-gradient(180deg, rgba(199,92,58,.25), rgba(226,162,58,.18));
      opacity:.45;
      pointer-events:none;
    }
    .paper > *{position:relative}

    .hand{
      font-family: "Segoe Print", "Bradley Hand", "Comic Sans MS", "Snell Roundhand", cursive;
      letter-spacing: .2px;
    }
    .pageTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .pageTitle{margin:0;font-size:18px;}
    .pageMeta{color:rgba(42,22,13,.65);font-size:12px}
    .pageBody{margin-top:10px;display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:900px){.pageBody{grid-template-columns:1fr .9fr;}}
    .noteBox{
      border:1px solid rgba(60,30,20,.14);
      border-radius:16px;
      background: rgba(255,255,255,.35);
      padding:12px;
    }
    .noteText{white-space:pre-wrap; line-height:1.55; font-size:15px; color:rgba(42,22,13,.92);}
    .sketchBox{
      border:1px solid rgba(60,30,20,.14);
      border-radius:16px;
      background: rgba(255,255,255,.25);
      padding:10px;
    }
    .sketchHint{font-size:12px;color:rgba(42,22,13,.60);margin-top:8px}

    .navRow{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-top:10px;}
    .navRow .ghost{border-color: rgba(60,30,20,.22); color: rgba(42,22,13,.88); background: rgba(255,255,255,.40);}
    .navRow button{padding:9px 12px;border-radius:12px;}

    /* Dashboard mini */
    .miniCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .scoreNum{font-size:34px;font-weight:900;margin:0;line-height:1;}
    .scoreLbl{color:rgba(255,255,255,.72);font-size:12px;margin-top:4px;}
    .bar{height:12px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);overflow:hidden;margin-top:10px;}
    .bar > div{height:100%;width:0%;}
    ul{list-style:none;padding:0;margin:10px 0 0;}
    li{
      padding:10px 0;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex;justify-content:space-between;gap:10px;
    }
    .small{color:rgba(255,255,255,.72);font-size:12px}
    .right{text-align:right}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Jurnal RelaÈ›ional</h1>
        <p class="subtitle">Completezi doar pentru azi sau zile trecute. Apoi rÄƒsfoieÈ™ti â€œpaginiâ€ ca Ã®ntr-un jurnal, cu text scris de mÃ¢nÄƒ È™i un sketch automat.</p>
      </div>
      <div class="pillbar">
        <div class="pill" id="streakPill">0 zile</div>
        <div class="pill" id="avgPill">Medie 7 zile: â€”</div>
        <div class="pill" id="countPill">IntrÄƒri: 0</div>
      </div>
    </header>

    <div class="grid">

      <!-- LEFT: FORM + JOURNAL -->
      <section class="card">
        <div class="tabs">
          <div class="tab active" id="tabFill">CompleteazÄƒ</div>
          <div class="tab" id="tabJournal">Jurnal (rÄƒsfoire)</div>
        </div>

        <!-- Fill view -->
        <div id="viewFill">
          <div class="two">
            <div>
              <label>Data (nu poÈ›i selecta zile viitoare)</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label>NotÄƒ</label>
              <input value="Datele se salveazÄƒ local Ã®n browser" disabled />
            </div>
          </div>

          <div id="questions" style="margin-top:12px; display:grid; gap:12px;"></div>

          <label>NotiÈ›e (opÈ›ional)</label>
          <textarea id="notes" placeholder="Ce s-a Ã®ntÃ¢mplat azi? Cum te-ai simÈ›it? Ce ai avea nevoie?"></textarea>

          <div class="btnrow">
            <button id="saveBtn">Save day</button>
            <button id="jumpJournalBtn" class="ghost">Vezi Ã®n jurnal</button>
            <button id="exportBtn" class="ghost">Export CSV</button>
            <button id="clearBtn" class="ghost">Clear all</button>
          </div>

          <p class="msg" id="msg"></p>
        </div>

        <!-- Journal view -->
        <div id="viewJournal" style="display:none;">
          <div class="paper hand">
            <div class="pageTop">
              <div>
                <p class="pageTitle" id="pageDate">â€”</p>
                <div class="pageMeta" id="pageMeta">â€”</div>
              </div>
              <div class="pageMeta" id="pageScore">â€”</div>
            </div>

            <div class="pageBody">
              <div class="noteBox">
                <div class="pageMeta" style="margin-bottom:6px;">NotiÈ›e</div>
                <div class="noteText" id="pageNotes">Nu existÄƒ Ã®ncÄƒ o intrare pentru aceastÄƒ zi.</div>
              </div>

              <div class="sketchBox">
                <canvas id="sketch" width="520" height="320" style="width:100%;height:auto;display:block;"></canvas>
                <div class="sketchHint" id="sketchHint">Sketch-ul se schimbÄƒ Ã®n funcÈ›ie de scorul zilei.</div>
              </div>
            </div>

            <div class="navRow">
              <button class="ghost" id="prevBtn">â† Ziua anterioarÄƒ</button>
              <div class="pageMeta" id="pageIndex">0/0</div>
              <button class="ghost" id="nextBtn">Ziua urmÄƒtoare â†’</button>
            </div>
          </div>

          <div class="msg" style="margin-top:10px;color:rgba(255,255,255,.75);">
            Tip: dacÄƒ vrei â€œÈ™i mai de mÃ¢nÄƒâ€, scrie notiÈ›ele mai narativ (2â€“5 propoziÈ›ii) È™i jurnalul aratÄƒ mult mai autentic.
          </div>
        </div>
      </section>

      <!-- RIGHT: DASHBOARD -->
      <aside class="card">
        <div class="miniCard">
          <div class="row">
            <div>
              <p class="scoreNum" id="scoreVal">â€”</p>
              <div class="scoreLbl" id="scoreLabel">CompleteazÄƒ È™i salveazÄƒ.</div>
            </div>
            <div class="pill" id="zonePill">ZonÄƒ: â€”</div>
          </div>
          <div class="bar"><div id="barFill"></div></div>
        </div>

        <div class="miniCard" style="margin-top:12px;">
          <div class="row">
            <div class="small">Trend (ultimele 14 zile)</div>
            <div class="small" id="trendMini">â€”</div>
          </div>
          <canvas id="trend" width="520" height="160" style="width:100%;height:auto;margin-top:10px;display:block;"></canvas>
        </div>

        <h3 style="margin:14px 0 6px; font-size:14px;">Istoric (ultimele 10)</h3>
        <ul id="history"></ul>
      </aside>

    </div>
  </div>

<script>
  // ---------------- Config ----------------
  const KEY = "rel_journal_v3";

  const QUESTIONS = [
    { id:"q1", text:"M-am simÈ›it respectat/Äƒ", positive:true },
    { id:"q2", text:"M-am simÈ›it ascultat/Äƒ", positive:true },
    { id:"q3", text:"M-am simÈ›it Ã®n siguranÈ›Äƒ emoÈ›ional", positive:true },
    { id:"q4", text:"Am simÈ›it susÈ›inere / Ã®ncurajare", positive:true },
    { id:"q5", text:"M-am simÈ›it apropiat/Äƒ (conexiune)", positive:true },
    { id:"q6", text:"M-am simÈ›it criticat/Äƒ sau invalidat/Äƒ", positive:false } // inversÄƒ
  ];

  const EMOJI = {
    1:{e:"ğŸ˜", t:"deloc"},
    2:{e:"ğŸ˜•", t:"puÈ›in"},
    3:{e:"ğŸ˜", t:"ok"},
    4:{e:"ğŸ™‚", t:"mult"},
    5:{e:"ğŸ˜", t:"foarte mult"}
  };

  // ---------------- Helpers ----------------
  const $ = (id) => document.getElementById(id);
  const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function loadAll(){
    try { return JSON.parse(localStorage.getItem(KEY)) || []; }
    catch { return []; }
  }

  function saveAll(items){
    localStorage.setItem(KEY, JSON.stringify(items));
  }

  function to100(x){ return ((x - 1) / 4) * 100; }

  function computeScore(entry){
    const perQ = QUESTIONS.map(q => {
      const raw = Number(entry[q.id]);
      const val = q.positive ? raw : (6 - raw); // invert
      return to100(val);
    });
    const avg = perQ.reduce((a,b)=>a+b,0) / perQ.length;
    return Math.round(avg);
  }

  function zone(score){
    if(score < 40) return {name:"RoÈ™u", color:getCSS("--terracotta"), hint:"tensiune / apÄƒsare"};
    if(score < 70) return {name:"Galben", color:getCSS("--amber"), hint:"amestec / instabil"};
    return {name:"Verde", color:getCSS("--olive"), hint:"conectare / siguranÈ›Äƒ"};
  }

  function scoreLabel(score){
    if(score < 40) return "ZonÄƒ de alertÄƒ: observÄƒ tiparele È™i protejeazÄƒ-È›i energia.";
    if(score < 70) return "ZonÄƒ instabilÄƒ: mix de bine È™i tensiuni.";
    return "ZonÄƒ bunÄƒ: conectare È™i siguranÈ›Äƒ.";
  }

  function getCSS(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  function movingAvg(items, days){
    const sorted = [...items].sort((a,b)=> a.date.localeCompare(b.date));
    const last = sorted.slice(-days);
    if(last.length === 0) return null;
    const avg = last.reduce((s,x)=>s + x.score, 0) / last.length;
    return Math.round(avg);
  }

  function streak(items){
    const set = new Set(items.map(x=>x.date));
    let d = new Date();
    let count = 0;
    while(true){
      const iso = d.toISOString().slice(0,10);
      if(set.has(iso)){
        count++;
        d.setDate(d.getDate()-1);
      } else break;
    }
    return count;
  }

  function isFutureDate(iso){
    return iso > todayISO();
  }

  // ---------------- UI build: questions ----------------
  function buildQuestions(){
    const wrap = $("questions");
    wrap.innerHTML = "";
    QUESTIONS.forEach((q) => {
      const div = document.createElement("div");
      div.className = "q";
      div.innerHTML = `
        <div class="qtop">
          <p class="qtitle">${q.text}${q.positive ? "" : " (inversÄƒ)"}</p>
          <div class="qmeta">
            <span class="emoji" id="${q.id}_emoji">ğŸ˜</span>
            <span class="badge" id="${q.id}_badge">3 Â· ok</span>
          </div>
        </div>
        <input class="slider" id="${q.id}" type="range" min="1" max="5" step="1" value="3" />
        <div class="scale"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
      `;
      wrap.appendChild(div);

      const slider = $(q.id);
      slider.addEventListener("input", () => updateQBadge(q.id, Number(slider.value)));
    });
  }

  function updateQBadge(qid, val){
    const e = EMOJI[val];
    $(`${qid}_emoji`).textContent = e.e;
    $(`${qid}_badge`).textContent = `${val} Â· ${e.t}`;
  }

  // ---------------- Drawing: trend ----------------
  function drawTrend(items){
    const canvas = $("trend");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    // grid
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = 14 + i*((H-28)/4);
      ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(W-10,y); ctx.stroke();
    }

    const sorted = [...items].sort((a,b)=> a.date.localeCompare(b.date));
    const last = sorted.slice(-14);
    $("trendMini").textContent = last.length ? `${last[0].date} â†’ ${last[last.length-1].date}` : "â€”";
    if(last.length === 0) return;

    const xs = last.map((_,i)=> 10 + i*((W-20)/Math.max(1,last.length-1)));
    const ys = last.map(x => {
      const s = clamp(x.score,0,100);
      return 14 + (1 - s/100) * (H-28);
    });

    const col = "rgba(226,162,58,.95)";
    ctx.strokeStyle = col;
    ctx.lineWidth = 2.2;

    ctx.beginPath();
    xs.forEach((x,i)=>{
      const y = ys[i];
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = col;
    xs.forEach((x,i)=>{
      ctx.beginPath(); ctx.arc(x,ys[i],3,0,Math.PI*2); ctx.fill();
    });
  }

  // ---------------- Drawing: pencil sketch ----------------
  function rnd(seed){
    // deterministic-ish random from seed string
    let h = 2166136261;
    for(let i=0;i<seed.length;i++){
      h ^= seed.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return function(){
      // xorshift
      h ^= h << 13; h ^= h >>> 17; h ^= h << 5;
      return (h >>> 0) / 4294967296;
    };
  }

  function pencil(ctx, x1,y1,x2,y2, jitter, passes, r){
    ctx.strokeStyle = "rgba(42,22,13,.52)";
    ctx.lineWidth = 1.1;
    ctx.lineCap = "round";
    for(let p=0;p<passes;p++){
      const jx = (r()-0.5)*jitter;
      const jy = (r()-0.5)*jitter;
      ctx.beginPath();
      ctx.moveTo(x1 + jx, y1 + jy);
      ctx.lineTo(x2 + jx, y2 + jy);
      ctx.stroke();
    }
  }

  function hatch(ctx, x,y,w,h, spacing, angle, r){
    ctx.save();
    ctx.translate(x+w/2, y+h/2);
    ctx.rotate(angle);
    ctx.translate(-(x+w/2), -(y+h/2));
    for(let i=-h;i<w+h;i+=spacing){
      pencil(ctx, x+i, y, x+i+h+w, y+h+w, 1.6, 2, r);
    }
    ctx.restore();
  }

function drawSketch(entry){
  const c = $("sketch");
  const ctx = c.getContext("2d");
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  // light paper tint
  ctx.fillStyle = "rgba(255,255,255,.20)";
  ctx.fillRect(0,0,W,H);

  const r = rnd(entry.date + "|" + entry.score + "|" + (entry.notes||""));
  const z = zone(entry.score);

  // --- helpers (romantic pencil style) ---
  function pencilStroke(alpha=0.55, lw=1.15){
    ctx.strokeStyle = `rgba(42,22,13,${alpha})`;
    ctx.lineWidth = lw;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }

  function pencilLine(x1,y1,x2,y2,jitter=2.0,passes=3){
    for(let p=0;p<passes;p++){
      const jx = (r()-0.5)*jitter;
      const jy = (r()-0.5)*jitter;
      ctx.beginPath();
      ctx.moveTo(x1 + jx, y1 + jy);
      ctx.lineTo(x2 + jx, y2 + jy);
      ctx.stroke();
    }
  }

  function scribbleCircle(cx,cy,rad,loops=3){
    for(let k=0;k<loops;k++){
      ctx.beginPath();
      const rr = rad + (r()-0.5)*2.2;
      ctx.arc(cx,cy,rr,0,Math.PI*2);
      ctx.stroke();
    }
  }

  function heartPath(cx,cy,size,rot=0){
    // classic heart param curve
    // scaled & rotated, then offset
    const pts = [];
    const steps = 90;
    for(let i=0;i<=steps;i++){
      const t = (i/steps) * Math.PI*2;
      const x = 16*Math.pow(Math.sin(t),3);
      const y = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
      pts.push({x, y});
    }
    // normalize to size
    // heart spans about x [-16,16], y [-17,13] so height ~30
    const sx = size/32;
    const sy = size/32;
    const cr = Math.cos(rot), sr = Math.sin(rot);

    ctx.beginPath();
    pts.forEach((p,idx)=>{
      let x = p.x*sx;
      let y = -p.y*sy; // flip for canvas
      const xr = x*cr - y*sr;
      const yr = x*sr + y*cr;
      const px = cx + xr;
      const py = cy + yr;
      if(idx===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    });
    ctx.closePath();
  }

  function pencilHeart(cx,cy,size){
    const rot = (r()-0.5)*0.35;
    const passes = 2 + Math.floor(r()*3);
    const jitter = 1.4 + r()*1.2;
    for(let p=0;p<passes;p++){
      ctx.save();
      ctx.translate((r()-0.5)*jitter, (r()-0.5)*jitter);
      heartPath(cx,cy,size, rot + (r()-0.5)*0.08);
      ctx.stroke();
      ctx.restore();
    }
  }

  function hatchBox(x,y,w,h,spacing=10,angle=0.3){
    ctx.save();
    ctx.translate(x+w/2, y+h/2);
    ctx.rotate(angle);
    ctx.translate(-(x+w/2), -(y+h/2));
    for(let i=-h;i<w+h;i+=spacing){
      pencilLine(x+i, y, x+i+h+w, y+h+w, 1.7, 2);
    }
    ctx.restore();
  }

  function tinyStar(cx,cy,size=10){
    const spikes = 5;
    const outer = size;
    const inner = size*0.45;
    const rot = (r()-0.5)*0.6;
    const step = Math.PI / spikes;
    ctx.beginPath();
    for(let i=0;i<spikes*2;i++){
      const rad = (i%2===0) ? outer : inner;
      const ang = rot + i*step;
      const x = cx + Math.cos(ang)*rad;
      const y = cy + Math.sin(ang)*rad;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    // pencil multi-pass
    for(let p=0;p<3;p++){
      ctx.save();
      ctx.translate((r()-0.5)*1.2, (r()-0.5)*1.2);
      ctx.stroke();
      ctx.restore();
    }
  }

  function tinyFlower(cx,cy,rad=10){
    const petals = 6 + Math.floor(r()*3);
    for(let i=0;i<petals;i++){
      const a = i*(Math.PI*2/petals);
      const px = cx + Math.cos(a)*rad*0.85;
      const py = cy + Math.sin(a)*rad*0.55;
      ctx.beginPath();
      ctx.ellipse(px,py, rad*0.55, rad*0.35, a, 0, Math.PI*2);
      for(let p=0;p<2;p++){
        ctx.save();
        ctx.translate((r()-0.5)*1.2, (r()-0.5)*1.2);
        ctx.stroke();
        ctx.restore();
      }
    }
    scribbleCircle(cx,cy,rad*0.35, 2);
  }

  function ribbon(x1,y1,x2,y2,wiggle=18,segments=8){
    // wavy ribbon line
    let px=x1, py=y1;
    for(let i=1;i<=segments;i++){
      const t=i/segments;
      const x = x1 + (x2-x1)*t;
      const y = y1 + (y2-y1)*t + Math.sin(t*Math.PI*2 + r()*1.8)*wiggle*(0.6+r()*0.4);
      pencilLine(px,py,x,y,2.0,2);
      px=x; py=y;
    }
  }

  // --- background pencil texture ---
  pencilStroke(0.18, 1.0);
  for(let i=0;i<10;i++){
    const x = r()*W, y = r()*H;
    const w = 80 + r()*160, h = 40 + r()*120;
    hatchBox(x-w/2, y-h/2, w, h, 14 + r()*10, (r()-0.5)*0.7);
  }

  // pick a "romantic scene" variant
  const scene = Math.floor(r()*4); // 0..3
  const score = entry.score;

  // intensity based on score
  const warmth = clamp((score-35)/65, 0, 1); // 0..1
  const heartsCount = 5 + Math.floor(warmth*10) + Math.floor(r()*4);
  const sparkles = 4 + Math.floor(warmth*10) + Math.floor(r()*4);
  const flowers = 1 + Math.floor(warmth*5) + Math.floor(r()*2);

  // pencil style (slightly changes)
  pencilStroke(0.52, 1.15);

  // --- scenes ---
  if(scene === 0){
    // "Heart constellation" + ribbon
    ribbon(W*0.08, H*0.60, W*0.92, H*0.35, 14 + r()*10, 9);

    for(let i=0;i<heartsCount;i++){
      const x = W*(0.15 + r()*0.70);
      const y = H*(0.15 + r()*0.55);
      const s = 18 + r()*36*(0.5+warmth);
      pencilHeart(x,y,s);
    }
    for(let i=0;i<sparkles;i++){
      tinyStar(W*(0.12+r()*0.76), H*(0.10+r()*0.70), 6 + r()*8);
    }
    for(let i=0;i<flowers;i++){
      tinyFlower(W*(0.12+r()*0.28), H*(0.62+r()*0.28), 8 + r()*10);
    }

  } else if(scene === 1){
    // "Two hearts + aura"
    const cx=W*0.45, cy=H*0.52;
    const cx2=W*0.60, cy2=H*0.50;
    pencilHeart(cx,cy,72 + warmth*40);
    pencilHeart(cx2,cy2,64 + warmth*38);

    // aura circles
    pencilStroke(0.30, 1.1);
    for(let k=0;k<5;k++){
      scribbleCircle((cx+cx2)/2, (cy+cy2)/2, 70 + k*18 + r()*4, 2);
    }

    // sparkles around
    pencilStroke(0.50, 1.15);
    for(let i=0;i<sparkles+4;i++){
      tinyStar(W*(0.18+r()*0.68), H*(0.18+r()*0.64), 7 + r()*10);
    }

    // small flowers bottom
    for(let i=0;i<flowers+1;i++){
      tinyFlower(W*(0.16+r()*0.70), H*(0.78+r()*0.14), 8 + r()*10);
    }

  } else if(scene === 2){
    // "Frame of hearts" (like a page border)
    const margin = 28;
    const perSide = 5 + Math.floor(r()*4);
    for(let i=0;i<perSide;i++){
      const t = (i+0.5)/perSide;
      pencilHeart(margin + t*(W-2*margin), margin, 16 + r()*10);
      pencilHeart(margin + t*(W-2*margin), H-margin, 16 + r()*10);
      pencilHeart(margin, margin + t*(H-2*margin), 16 + r()*10);
      pencilHeart(W-margin, margin + t*(H-2*margin), 16 + r()*10);
    }

    // center motif (rose-ish)
    const centerX=W*0.52, centerY=H*0.52;
    pencilStroke(0.48, 1.2);
    for(let k=0;k<6;k++){
      ctx.beginPath();
      ctx.ellipse(centerX, centerY, 22+k*12, 14+k*10, (r()-0.5)*0.6, 0, Math.PI*2);
      ctx.stroke();
    }
    for(let i=0;i<sparkles;i++){
      tinyStar(W*(0.18+r()*0.68), H*(0.18+r()*0.64), 7 + r()*9);
    }

  } else {
    // "Love letter vibe": ribbon + heart stamp + doodles
    ribbon(W*0.10, H*0.25, W*0.88, H*0.28, 10 + r()*8, 8);
    ribbon(W*0.12, H*0.75, W*0.90, H*0.68, 14 + r()*10, 8);

    // stamp heart
    const sx=W*0.78, sy=H*0.58;
    pencilStroke(0.50, 1.25);
    pencilHeart(sx,sy,86 + warmth*30);
    pencilStroke(0.25, 1.05);
    hatchBox(sx-62, sy-52, 120, 100, 12, 0.65);

    // scattered small hearts
    pencilStroke(0.52, 1.15);
    for(let i=0;i<heartsCount-2;i++){
      const x = W*(0.12 + r()*0.64);
      const y = H*(0.20 + r()*0.60);
      const s = 14 + r()*22*(0.7+warmth);
      pencilHeart(x,y,s);
    }
    for(let i=0;i<sparkles;i++){
      tinyStar(W*(0.10+r()*0.78), H*(0.10+r()*0.78), 6 + r()*8);
    }
  }

  // --- handwritten caption (romantic + varies) ---
  const captions = [
    "azi am simÈ›it cÄƒldurÄƒ",
    "azi am simÈ›it apropiere",
    "azi a fost mai blÃ¢nd",
    "azi mi-a prins bine",
    "azi a fost greu, dar trece",
    "azi m-a atins la inimÄƒ",
    "azi am avut nevoie de mai mult"
  ];
  const cap = captions[Math.floor(r()*captions.length)];

  ctx.fillStyle = "rgba(42,22,13,.78)";
  ctx.font = "18px 'Segoe Print','Bradley Hand','Comic Sans MS',cursive";
  ctx.fillText(`${cap} â€¢ ${z.name.toLowerCase()}`, 16, H - 18);
}


  // ---------------- Views / Tabs ----------------
  function setActiveTab(tab){
    const fillTab = $("tabFill");
    const journalTab = $("tabJournal");
    const vf = $("viewFill");
    const vj = $("viewJournal");

    if(tab === "fill"){
      fillTab.classList.add("active");
      journalTab.classList.remove("active");
      vf.style.display = "";
      vj.style.display = "none";
    } else {
      journalTab.classList.add("active");
      fillTab.classList.remove("active");
      vj.style.display = "";
      vf.style.display = "none";
    }
  }

  // ---------------- Journal paging ----------------
  let journalDates = [];     // sorted ascending
  let journalIndex = 0;

  function refreshJournalModel(items){
    journalDates = [...items].map(x=>x.date).sort((a,b)=>a.localeCompare(b));
    journalIndex = clamp(journalIndex, 0, Math.max(0, journalDates.length-1));
  }

  function getEntryByDate(items, date){
    return items.find(x => x.date === date) || null;
  }

  function renderJournal(){
    const items = loadAll();
    refreshJournalModel(items);

    if(journalDates.length === 0){
      $("pageDate").textContent = "Nu ai Ã®ncÄƒ intrÄƒri";
      $("pageMeta").textContent = "CompleteazÄƒ o zi È™i revino aici.";
      $("pageScore").textContent = "";
      $("pageNotes").textContent = "â€”";
      $("pageIndex").textContent = "0/0";
      // empty sketch
      const c = $("sketch"); c.getContext("2d").clearRect(0,0,c.width,c.height);
      $("sketchHint").textContent = "Sketch-ul apare dupÄƒ ce salvezi o zi.";
      return;
    }

    const date = journalDates[journalIndex];
    const entry = getEntryByDate(items, date);
    const z = zone(entry.score);

    $("pageDate").textContent = `Ziua: ${date}`;
    $("pageMeta").textContent = `Stare: ${z.name} Â· ${z.hint}`;
    $("pageScore").textContent = `Scor: ${entry.score}/100`;
    $("pageNotes").textContent = entry.notes ? entry.notes : "(fÄƒrÄƒ notiÈ›e)";
    $("pageIndex").textContent = `${journalIndex+1}/${journalDates.length}`;
    $("sketchHint").textContent = `Sketch: ${z.name} (${z.hint})`;

    drawSketch(entry);

    $("prevBtn").disabled = (journalIndex === 0);
    $("nextBtn").disabled = (journalIndex === journalDates.length - 1);
    $("prevBtn").style.opacity = $("prevBtn").disabled ? 0.6 : 1;
    $("nextBtn").style.opacity = $("nextBtn").disabled ? 0.6 : 1;
  }

  // ---------------- Dashboard render ----------------
  function renderDashboard(){
    const items = loadAll();
    const sortedDesc = [...items].sort((a,b)=> b.date.localeCompare(a.date));

    $("countPill").textContent = `IntrÄƒri: ${items.length}`;
    $("streakPill").textContent = `${streak(items)} zile`;
    const avg7 = movingAvg(items, 7);
    $("avgPill").textContent = `Medie 7 zile: ${avg7 == null ? "â€”" : avg7}`;

    if(sortedDesc.length === 0){
      $("scoreVal").textContent = "â€”";
      $("scoreLabel").textContent = "CompleteazÄƒ È™i salveazÄƒ.";
      $("zonePill").textContent = "ZonÄƒ: â€”";
      $("barFill").style.width = "0%";
      $("barFill").style.background = "transparent";
      $("history").innerHTML = "";
      drawTrend([]);
      return;
    }

    const latest = sortedDesc[0];
    const z = zone(latest.score);

    $("scoreVal").textContent = latest.score;
    $("scoreLabel").textContent = scoreLabel(latest.score);
    $("zonePill").textContent = `ZonÄƒ: ${z.name}`;
    $("barFill").style.width = `${clamp(latest.score,0,100)}%`;
    $("barFill").style.background = `linear-gradient(90deg, ${getCSS("--amber")}, ${getCSS("--terracotta")})`;

    drawTrend(items);

    const ul = $("history");
    ul.innerHTML = "";
    sortedDesc.slice(0,10).forEach(it=>{
      const z2 = zone(it.score);
      const li = document.createElement("li");
      const left = document.createElement("div");
      left.innerHTML = `<div><strong>${it.date}</strong></div>
                        <div class="small">${(it.notes||"").slice(0,46)}${(it.notes||"").length>46?"â€¦":""}</div>`;
      const right = document.createElement("div");
      right.className = "right";
      right.innerHTML = `<div style="font-weight:900;color:rgba(255,255,255,.92)">${it.score}</div>
                         <div class="small">${z2.name}</div>`;
      li.appendChild(left);
      li.appendChild(right);
      ul.appendChild(li);
    });
  }

  // ---------------- Actions ----------------
  function currentEntryFromUI(){
    const entry = { date: $("date").value || todayISO(), notes: $("notes").value.trim() };
    QUESTIONS.forEach(q => entry[q.id] = Number($(q.id).value));
    entry.score = computeScore(entry);
    return entry;
  }

  function saveEntry(){
    const entry = currentEntryFromUI();

    // block future dates (hard validation)
    if(!entry.date){
      $("msg").textContent = "SelecteazÄƒ o datÄƒ.";
      return;
    }
    if(isFutureDate(entry.date)){
      $("msg").textContent = "Nu poÈ›i salva pentru zile viitoare. Alege azi sau o zi din trecut.";
      return;
    }

    const items = loadAll();
    const idx = items.findIndex(x => x.date === entry.date);
    if(idx >= 0) items[idx] = entry; else items.push(entry);
    saveAll(items);

    $("msg").textContent = `Salvat âœ“  Scor: ${entry.score}/100 (${zone(entry.score).name})`;
    renderDashboard();
    // keep journal in sync
    renderJournal();
  }

  function clearAll(){
    localStorage.removeItem(KEY);
    $("notes").value = "";
    QUESTIONS.forEach(q => { $(q.id).value = 3; updateQBadge(q.id, 3); });
    $("msg").textContent = "Datele au fost È™terse din acest browser.";
    renderDashboard();
    renderJournal();
  }

  function exportCSV(){
    const items = loadAll().sort((a,b)=> a.date.localeCompare(b.date));
    if(items.length === 0){
      $("msg").textContent = "Nu ai date de exportat.";
      return;
    }
    const headers = ["date", ...QUESTIONS.map(q=>q.id), "score", "notes"];
    const esc = (s) => `"${String(s ?? "").replaceAll('"','""')}"`;
    const lines = [headers.join(",")].concat(
      items.map(it => headers.map(h => esc(it[h])).join(","))
    );
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "jurnal_relational.csv";
    a.click();
    URL.revokeObjectURL(url);
    $("msg").textContent = "Export fÄƒcut âœ“";
  }

  function jumpToJournalLatest(){
    const items = loadAll();
    refreshJournalModel(items);
    journalIndex = Math.max(0, journalDates.length - 1);
    setActiveTab("journal");
    renderJournal();
  }

  // ---------------- Init ----------------
  buildQuestions();
  // lock date picker: no future
  $("date").value = todayISO();
  $("date").max = todayISO();

  // Also prevent manual typing to future dates: still validated on save anyway.
  $("date").addEventListener("change", () => {
    if($("date").value && isFutureDate($("date").value)){
      $("date").value = todayISO();
      $("msg").textContent = "Zilele viitoare sunt blocate. Am revenit la azi.";
    }
  });

  QUESTIONS.forEach(q => updateQBadge(q.id, 3));

  renderDashboard();
  renderJournal();

  // tabs
  $("tabFill").addEventListener("click", () => setActiveTab("fill"));
  $("tabJournal").addEventListener("click", () => { setActiveTab("journal"); renderJournal(); });

  // buttons
  $("saveBtn").addEventListener("click", saveEntry);
  $("clearBtn").addEventListener("click", clearAll);
  $("exportBtn").addEventListener("click", exportCSV);
  $("jumpJournalBtn").addEventListener("click", jumpToJournalLatest);

  // journal nav
  $("prevBtn").addEventListener("click", () => { journalIndex = Math.max(0, journalIndex-1); renderJournal(); });
  $("nextBtn").addEventListener("click", () => { journalIndex = Math.min(journalDates.length-1, journalIndex+1); renderJournal(); });

</script>
</body>
</html>
